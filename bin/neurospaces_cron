#!/usr/bin/perl -w
#!/usr/bin/perl -d:ptkdb -w
#


use strict;


use Getopt::Long;

use YAML;


my $installer_directory = "$ENV{HOME}/neurospaces_project/installer/source/snapshots/0";

my $output_filename = "/tmp/neurospaces_cron.stdout";


sub main
{
    # unlink the output file

    unlink($output_filename);

    chdir("/tmp");

    # prepare an initial directory layout

    try_to("neurospaces_create_directories");

    # pull code from the repositories

    try_to("neurospaces_pull");

    # uninstall what was installed

    try_to("neurospaces_uninstall");

    install_installer();

    # update the source code in the worspaces

    try_to("neurospaces_update");

    # loop over all the configurations we want to test

    foreach my $configuration (1)
    {
	#t insert configuration options in the configurator package

	# install without check

	try_to("neurospaces_install");

	# uninstall again

	try_to("neurospaces_uninstall");

	install_installer();

	# check with install

	try_to("neurospaces_check");

	# uninstall again

	try_to("neurospaces_uninstall");

	install_installer();

    }
}


sub install_installer
{
    chdir($installer_directory);

    try_to("make && sudo make install");
}


sub report_error
{
    my $command = shift;

    my $error_code = shift;

    #t send emails

    die "$0: $command returned $error_code";
}


sub try_to
{
    my $command = shift;

    print "---\n";
    print "$0: trying to $command\n";

    my $output = `$command >>$output_filename 2>&1`;

    if ($?)
    {
	report_error($command, $?);
    }
}


main();


